#!/bin/bash

# Redis Installation Script for HestiaCP
# Adapted from MyVestaCP script for HestiaCP
# Author: Adapted for HestiaCP
# Version: 1.0

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_status() {
    echo -e "${BLUE}===========================${NC}"
    echo -e "${BLUE}== $1${NC}"
    echo -e "${BLUE}===========================${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "This script must be run as root"
        exit 1
    fi
}

check_hestia() {
    if [ ! -d "/usr/local/hestia" ]; then
        print_error "HestiaCP was not found on this server"
        exit 1
    fi
}

get_memory() {
    echo $(grep 'MemTotal' /proc/meminfo | tr ' ' '\n' | grep [0-9])
}

get_php_versions() {
    # Get all PHP versions installed via HestiaCP
    systemctl --full --type service --all | grep "php.*-fpm" | sed 's#●##g' | awk '{print $1}' | sed 's/-fpm.service//g' | sort -u
}

install_redis_server() {
    print_status "Installing Redis Server"
    
    # Update package list
    apt-get update -qq
    
    # Install Redis server
    if apt-get install -y redis-server; then
        print_success "Redis server installed successfully"
    else
        print_error "Error installing Redis server"
        exit 1
    fi
}

install_php_redis_extensions() {
    print_status "Installing PHP Redis extensions"
    
    local php_versions=$(get_php_versions)
    local installed_extensions=""
    
    if [ -z "$php_versions" ]; then
        print_warning "No PHP versions found"
        return
    fi
    
    echo "Detected PHP versions:"
    for version in $php_versions; do
        echo "  - $version"
    done
    
    # Install extension for each PHP version
    for version in $php_versions; do
        local package_name="${version}-redis"
        echo -n "Installing $package_name... "
        
        if apt-get install -y "$package_name" >/dev/null 2>&1; then
            print_success "$package_name installed"
            installed_extensions="$installed_extensions $package_name"
        else
            print_warning "Error installing $package_name"
        fi
    done
    
    # Try to install the generic extension
    if apt-get install -y php-redis >/dev/null 2>&1; then
        print_success "php-redis (generic) installed"
    fi
    
    print_success "Installed PHP Redis extensions: $installed_extensions"
}

configure_redis() {
    print_status "Configuring Redis"
    
    local memory=$(get_memory)
    local redis_conf="/etc/redis/redis.conf"
    
    if [ ! -f "$redis_conf" ]; then
        print_error "Redis configuration file not found: $redis_conf"
        exit 1
    fi
    
    # Backup original configuration
    cp "$redis_conf" "$redis_conf.backup.$(date +%Y%m%d_%H%M%S)"
    print_success "Configuration backup created"
    
    # Set supervised to systemd
    sed -i "s|^supervised no|supervised systemd|g" "$redis_conf"
    print_success "Configured supervised systemd"
    
    # Disable automatic saves (for performance)
    sed -i "s|^save |# save |g" "$redis_conf"
    sed -i 's|^# save ""|save ""|g' "$redis_conf"
    print_success "Automatic saves disabled for performance"
    
    # Set maxmemory based on available RAM
    if [ $memory -lt 15000000 ]; then
        # Under 15GB RAM - set 256MB for Redis
        sed -i "s|^# maxmemory .*|maxmemory 256mb|g" "$redis_conf"
        print_success "Maxmemory set to 256MB (low RAM detected)"
    else
        # Over 15GB RAM - set 1GB for Redis
        sed -i "s|^# maxmemory .*|maxmemory 1gb|g" "$redis_conf"
        print_success "Maxmemory set to 1GB (high RAM detected)"
    fi
    
    # Set eviction policy
    sed -i "s|^# maxmemory-policy .*|maxmemory-policy allkeys-lru|g" "$redis_conf"
    print_success "Maxmemory-policy set to allkeys-lru"
    
    # Bind only to localhost for security
    sed -i "s|^bind 127.0.0.1.*|bind 127.0.0.1|g" "$redis_conf"
    print_success "Redis bind configured for localhost"
    
    # Disable protected mode for local connections
    sed -i "s|^protected-mode yes|protected-mode no|g" "$redis_conf"
}

start_redis_services() {
    print_status "Starting and enabling Redis services"
    
    # Enable Redis to start automatically
    if systemctl enable redis-server; then
        print_success "Redis enabled for autostart"
    else
        print_error "Error enabling Redis for autostart"
    fi
    
    # Restart Redis to apply configuration
    if systemctl restart redis-server; then
        print_success "Redis restarted successfully"
    else
        print_error "Error restarting Redis"
        exit 1
    fi
    
    # Check status
    sleep 2
    if systemctl is-active --quiet redis-server; then
        print_success "Redis is running"
    else
        print_error "Redis is not running - check logs"
        exit 1
    fi
}

test_redis() {
    print_status "Testing Redis connection"
    
    # Test PING
    if redis-cli ping | grep -q "PONG"; then
        print_success "Redis responds to PING"
    else
        print_error "Redis does not respond to PING"
        return 1
    fi
    
    # Test SET/GET
    redis-cli set test_key "test_value" >/dev/null
    if [ "$(redis-cli get test_key)" = "test_value" ]; then
        print_success "Redis SET/GET works"
        redis-cli del test_key >/dev/null
    else
        print_error "Redis SET/GET does not work"
        return 1
    fi
}

show_redis_info() {
    print_status "Redis Information"
    
    echo -e "${YELLOW}Redis Memory:${NC}"
    redis-cli info memory | grep -E "(used_memory_human|maxmemory_human)"
    
    echo -e "${YELLOW}Configuration:${NC}"
    echo "  - Port: $(redis-cli config get port | tail -1)"
    echo "  - Maxmemory: $(redis-cli config get maxmemory | tail -1)"
    echo "  - Maxmemory-policy: $(redis-cli config get maxmemory-policy | tail -1)"
    
    echo -e "${YELLOW}For WordPress:${NC}"
    echo "  - Install the 'Redis Object Cache' plugin"
    echo "  - Add to wp-config.php:"
    echo "    define('WP_REDIS_HOST', '127.0.0.1');"
    echo "    define('WP_REDIS_PORT', 6379);"
}

restart_php_services() {
    print_status "Restarting PHP services to load Redis extensions"
    
    local php_versions=$(get_php_versions)
    
    for version in $php_versions; do
        local service_name="${version}-fpm"
        echo -n "Restarting $service_name... "
        
        if systemctl restart "$service_name" 2>/dev/null; then
            print_success "$service_name restarted"
        else
            print_warning "Error restarting $service_name"
        fi
    done
}

main() {
    clear
    
    print_status "Installing Redis for HestiaCP"
    echo "This script will install and configure Redis on your HestiaCP server"
    echo "Adapted from MyVestaCP script"
    echo ""
    
    # Preliminary checks
    check_root
    check_hestia
    
    # Show system info
    echo "Total RAM detected: $(get_memory | awk '{print int($1/1024/1024)" GB"}')"
    echo "Detected PHP versions: $(get_php_versions | wc -w)"
    echo ""
    
    read -p "Continue with installation? [y/N]: " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_warning "Installation cancelled"
        exit 0
    fi
    
    # Installation process
    install_redis_server
    install_php_redis_extensions
    configure_redis
    start_redis_services
    restart_php_services
    
    # Testing and displaying information
    if test_redis; then
        echo ""
        print_success "Redis installed and configured successfully!"
        echo ""
        show_redis_info
    else
        print_error "Installation completed but tests failed"
        exit 1
    fi
    
    echo ""
    print_status "Redis installation completed!"
    echo -e "${GREEN}Redis is now available for your applications.${NC}"
    echo "Redis path: [$redis_conf]"
    echo ""
}

# Run script
main "$@"
